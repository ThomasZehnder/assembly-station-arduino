<!DOCTYPE html>
<html>

<head>
    <title>IIoT Demonstrator</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">


    <!--CodeMirror instance -->
    <link rel="stylesheet" href="lib/codemirror.css">
    <script src="lib/codemirror.js"></script>
    <script src="addon/mode/javascript/javascript.js"></script>
    <link rel="stylesheet" href="theme/cobalt.css">

    <link rel="stylesheet" href="addon/hint/show-hint.css">
    <script src="addon/hint/javascript-hint.js"></script>
    <script src="addon/hint/show-hint.js"></script>

    <script src="addon/edit/closebrackets.js"></script>
    <script src="addon/edit/closetag.js"></script>
    <script src="addon/edit/matchbrackets.js"></script>
    <script src="addon/edit/trailingspace.js"></script>

    <script>

        function loadMain(articleUrl, asideUrl, param) {
            loadArticle(articleUrl, param);
            loadAside(asideUrl);
        }

        function loadArticle(url, param) {
            fetch(url)
                .then(function (response) {
                    return response.text();
                })
                .then(function (html) {
                    //console.log(html);
                    const myArticle = document.getElementById("articleId");
                    myArticle.innerHTML = html;

                    //execude page initializizer
                    //console.log("loaded url: ", url);
                    if (url.startsWith('a-config')) {
                        //console.log("Load Configpage: ", param)
                        //loadElement(param, "preId");
                        loadEditor(param);
                        setH3Title(String("Edit ") + param);
                    }
                    else if (url.startsWith('a-files')) {
                        console.log("Load files: ", param)
                        loadElement(param, "preId");
                    }
                    else if (url.startsWith('a-js-editor')) {
                        console.log("JavaSript file: ", param)
                        loadEditor(param);
                        setH3Title(String("Editor for ") + param);
                    }
                    else if (url.startsWith('a-js-monitor')) {
                        console.log("JavaSript file: ", param)
                        loadEditor(param);
                        setH3Title(String("Monitor ") + param);
                    }
                });
        }

        function loadAside(url, param) {

            fetch(url)
                .then(function (response) {
                    return response.text();
                })
                .then(function (html) {
                    //console.log(html);
                    const myArticle = document.getElementById("asideId");
                    myArticle.innerHTML = html;
                });
        }

        function loadElement(url, id) {
            fetch(url)
                .then(function (response) {
                    return response.text();
                })
                .then(function (html) {
                    //console.log(html);
                    const myArticle = document.getElementById(id);
                    myArticle.innerHTML = html;
                });
        }

        function setH3Title(text) {
            const myH3 = document.getElementById("h3Id");
            myH3.innerHTML = text;
        }

        function setFooter(text) {
            const myfooter = document.getElementById("pFooter");
            myfooter.innerHTML = text;
        }

        <!-- Code Mirror functions-->
        var editorUrl = "";
        var editor;
        function loadEditor(url) {
            editorUrl = url;
            editor = CodeMirror.fromTextArea(document.getElementById("editorId"), {
                mode: {
                    name: "javascript",
                    globalVars: true
                },
                theme: "cobalt",
                lineNumbers: true,

                autoCloseBrackets: true,
                autoCloseTags: true,
                matchBrackets: true,
                showTrailingSpace: true,

                hint: CodeMirror.hint.javascript,

                extraKeys: {
                    "Ctrl-Space": "autocomplete"
                }

            });
            editor.save();
            loadCodeMirror();
        }
        function loadCodeMirror() {
            fetch(editorUrl)
                .then(function (response) {
                    return response.text();
                })
                .then(function (c) {
                    editor.setValue(c);
                    console.log("load click: ", editorUrl);
                    console.log(c);
                    setFooter("Load codemirror " + editorUrl + " done.")
                });
        }

        function saveCodeMirror() {
            var c = editor.getValue();
            console.log("save click: ", editorUrl);
            console.log(c);
            setFooter("saveCodeMirror... ");

            //validate JSON
            if (editorUrl.endsWith('.json')) {
                try {
                    var x = JSON.parse(c);

                } catch (e) {
                    alert('JSON not valid: ' + e);
                    setFooter("JSON error " + e);
                    console.log(e);
                    return;
                }
            }

            fetch('/store?name=' + editorUrl, {
                method: 'POST',
                body: c
            })
                .then(res => res.text())
                .then(res => {
                    console.log(res);
                    setFooter("saveCodeMirror ok " + res);
                })
                .catch(err => {
                    console.log(err);
                    setFooter("saveCodeMirror error " + err);
                })
        }
    </script>
</head>

<body onload="loadMain('a-home.html', 'aa-home.html',0);">
    <header>
        <h1>IIoT Demonstrator with ESP8266</h1>
    </header>
    <nav>
        <ul>
            <li><a onclick="loadMain('a-home.html', 'aa-home.html',0);">Home</a></li>
            <li><a onclick="loadArticle('a-files.html', 'dir');">Files</a></li>
            <li><a onclick="loadMain('a-js-editor.html', 'aa-js-editor.html','test.txt');">Javascript</a></li>
            <li><a onclick="loadMain('a-config.html', 'aa-config.html','config_main.json');">Config</a></li>
            <li><a onclick="loadArticle('a-contact.html');">Contact</a></li>
        </ul>

        <img class="logo" src="logo.png">

    </nav>


    <main>
        <article id="articleId">
            <h2> ... loading dynamicaly...</h2>

        </article>
        <aside id="asideId">
            <h2>... loading dynamicaly...</h2>

            <button onclick="loadArticle('a-home.html');">Home</button>
            <button onclick="loadArticle('dir');">Show files on ESP</button>
            <button onclick="loadArticle('upload');">Upload Page e.g. adopt configuration</button>
            <button onclick="loadArticle('reboot');">Reboot Arduino, e.g. to activate new configuration</button>

        </aside>

    </main>

    <footer>
        <p id="pFooter">&copy;&nbsp;Copyright 2023 by avm. All rights reversed.</p>
    </footer>

</body>

</html>